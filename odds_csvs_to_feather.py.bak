#!/usr/bin/env python
# -*- coding: utf-8 -*-
"""
odds_csvs_to_feather.py

æŒ‡å®šã—ãŸã€Œãƒ¬ãƒ¼ã‚¹ ID å…ˆé ­ 6 æ¡ã€ï¼ˆè¤‡æ•°å¯ï¼‰ã«ä¸€è‡´ã™ã‚‹
predicted_odds_******.csv ã‚’èª­ã¿è¾¼ã¿ã€1 ã¤ã® Feather ãƒ•ã‚¡ã‚¤ãƒ«ã¸ã¾ã¨ã‚ã‚‹ã€‚

ãƒ»æ–‡å­—ã‚³ãƒ¼ãƒ‰ã¯ UTF-8 / CP932 / Shift-JIS ã‚’è‡ªå‹•åˆ¤å®š
ãƒ»åˆ—åã®å‰å¾Œç©ºç™½ã‚’é™¤å»
ãƒ»ã€Œäººæ°—ã€ãƒ»å„ç¨®ã‚ªãƒƒã‚ºåˆ—ãªã©ã‚’æ•°å€¤åŒ–
   â”” æ•´æ•°ã®ã¿ â†’ Int64 (nullable)
   â”” å°‘æ•°ã‚’å«ã‚€ â†’ Float64 (nullable)
"""

from __future__ import annotations

import argparse
import glob
import os
import pathlib
import re
import sys

import pandas as pd


# ----------------------------------------------------------------------
# ãƒ˜ãƒ«ãƒ‘ãƒ¼
# ----------------------------------------------------------------------
ENCODINGS = ("utf-8", "cp932", "shift_jis")  # è©¦ã™é †

RE_DASHES = re.compile(r"[ï¼â€•â€“ï½°\-]")
RE_NUMCOL = re.compile(r"(äººæ°—|[0-9ï¼-ï¼™]+|.*ã‚ªãƒƒã‚º.*)")


def read_csv_best(path: str | pathlib.Path) -> pd.DataFrame | None:
    """å€™è£œã‚¨ãƒ³ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã§é †ã«èª­ã¿è¾¼ã‚€ã€‚å¤±æ•—ã—ãŸã‚‰ None"""
    for enc in ENCODINGS:
        try:
            return pd.read_csv(path, encoding=enc)
        except UnicodeDecodeError:
            continue
    print(f"âš ï¸  SKIP (encoding) {path}", file=sys.stderr)
    return None


def cast_numeric_columns(df: pd.DataFrame) -> pd.DataFrame:
    """æ•°å€¤ã£ã½ã„åˆ—ã‚’ Int64 / Float64 ã«å¤‰æ›"""
    num_cols = [c for c in df.columns if RE_NUMCOL.fullmatch(c)]
    for col in num_cols:
        cleaned = (
            df[col]
            .astype(str)
            .str.strip()
            .str.replace(",", "", regex=False)
            .str.replace(RE_DASHES, "", regex=True)
            .replace({"": None})
        )

        series = pd.to_numeric(cleaned, errors="coerce")

        # æ•´æ•°ã ã‘ãªã‚‰ Int64 (æ¬ æå¯)ã€ãã†ã§ãªã‘ã‚Œã° Float64
        if (series.dropna() % 1 == 0).all():
            df[col] = series.astype("Int64")
        else:
            df[col] = series.astype("Float64")

    return df


# ----------------------------------------------------------------------
# ãƒ¡ã‚¤ãƒ³
# ----------------------------------------------------------------------
def main() -> None:
    ap = argparse.ArgumentParser(
        description="predicted_odds_*.csv ã‚’ã¾ã¨ã‚ã¦ Feather ã«å¤‰æ›"
    )
    ap.add_argument(
        "--prefix",
        nargs="+",
        required=True,
        metavar="XXXXXX",
        help="ãƒ¬ãƒ¼ã‚¹ ID å…ˆé ­ 6 æ¡ã‚’ç©ºç™½åŒºåˆ‡ã‚Šã§æŒ‡å®šï¼ˆè¤‡æ•°å¯ï¼‰",
    )
    ap.add_argument(
        "--out",
        default="odds_output.feather",
        metavar="FILE",
        help="Feather å‡ºåŠ›ãƒ•ã‚¡ã‚¤ãƒ«åï¼ˆæ—¢å®š: odds_output.featherï¼‰",
    )
    args = ap.parse_args()

    base_dir = pathlib.Path(__file__).resolve().parent
    csvs: list[str] = sum(
        [
            glob.glob(str(base_dir / f"predicted_odds_{p}*.csv"))
            for p in args.prefix
        ],
        [],
    )

    if not csvs:
        sys.exit("âš ï¸  æŒ‡å®š prefix ã«ä¸€è‡´ã™ã‚‹ CSV ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚")

    print(f"ğŸ“„ {len(csvs)} CSV files found", file=sys.stderr)

    frames = [df for fp in csvs if (df := read_csv_best(fp)) is not None]
    if not frames:
        sys.exit("âš ï¸  æ–‡å­—ã‚³ãƒ¼ãƒ‰åˆ¤å®šã«å¤±æ•—ã—ã€çµåˆã§ãã‚‹ CSV ãŒã‚ã‚Šã¾ã›ã‚“ã€‚")

    df = pd.concat(frames, ignore_index=True)
    df.rename(columns=lambda c: c.strip(), inplace=True)
    df = cast_numeric_columns(df)

    df.to_feather(args.out)
    print(
        f"âœ… wrote {args.out}  ({os.path.getsize(args.out):,} bytes)",
        file=sys.stderr,
    )


if __name__ == "__main__":
    main()
